# Controller boot environment for Scarthgap u-boot-imx 2024.04
# Implements two-slot (LATEST/GOLDEN) MMC fallback and controller-specific bootargs.

bootdelay=0
mmcdev=1
mmcpart=2
mmcroot=/dev/mmcblk0p2 rootwait ro
uimage=uImage
fdt_file=imx6solo-controller.dtb
factoryReset=0
console=ttymxc0

# Common kernel args: HDMI at 720p, no blanking/cursor blink, optional factory reset flag.
mmcargs=setenv bootargs console=${console},${baudrate} ${smp} root=${mmcroot} video=mxcfb0:dev=hdmi,1280x720M@60 consoleblank=0 vt.global_cursor_default=0 factoryreset=${factoryReset}

# Load helpers
loaduimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${uimage}
loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}

# Boot helper (expects loaduimage already succeeded)
mmcboot=run mmcargs; if run loadfdt; then bootm ${loadaddr} - ${fdt_addr}; else bootm ${loadaddr}; fi

# Primary (LATEST) slot
boot_latest=setenv mmcpart 2; setenv mmcroot /dev/mmcblk0p2 rootwait ro; if run loaduimage; then run mmcboot; fi

# Fallback (GOLDEN) slot
boot_golden=setenv mmcpart 1; setenv mmcroot /dev/mmcblk0p1 rootwait ro; run loaduimage; run mmcboot

# Overall boot flow: always attempt LATEST then GOLDEN
bootcmd=mmc dev ${mmcdev}; run boot_latest; run boot_golden
